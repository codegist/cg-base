<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cg-utils/cg-utils.html">
<link rel="import" href="../cg-utils/cg-utilities-behavior.html">

<script>
    (function(){
        var GLOBALS = {
            ignoreVisibilityOnDataRequest:[],
            context:undefined
        };

        var CGBaseBehaviorImpl = {
            properties:{
                _cgbaseId:{
                    type:String,
                    readOnly:true
                },
                cgName:String,
                isAttached:Boolean,
                listensTo:{
                    type:Array,
                    value:["cg-application-event"],
                    observer:'listensToChanged',
                },
                globals:{ // TODO move to CG.GlobalAwareBehavior
                    value:GLOBALS,
                    observer:'globalsChanged',
                    readOnly:true
                },
                dataContext:{
                    type:Object,
//                    value:{},
                    observer:'dataContextChanged',
                    readOnly:true
                },
            },
            _eventsHandlers:{},
            _handlerMap:{
                "cg-application-event" : "onApplicationEvent", // TODO create one behavior for each event, eg: CG.ApplicationEventAwareBehavior, CG.ApplicationErrorAwareBehavior, CG.ApplicationLinkAwareBehavior etc..
                "cg-application-error" : "onApplicationError",
                "cg-application-link" : "onApplicationLink",
            },
            observers: [
                'globalsContextChanged(globals.context.*)',
//                'dataContextChanged(dataContext.*)'
// TODO see Specifically, Polymer provides two APIâ€™s that allow such changes to be notified to the system:
// TODO see notifyPath(path, value) and set(path, value), where path is a string identifying the path (relative to the host element).
            ],
            created:function(){
                this.async(function(){
                    this._listensTo("cg-global", this._onGlobalChangeEvent, false);
                });
            },
            ready:function(){
                this._set_cgbaseId(CG.Utils.Generators.id());
                //console.log("["+this.constructor.name+"] ready " + this._cgbaseId);
            },
            attached:function(){
                this.isAttached = true;
            },
            detached:function(){
                this.isAttached = false;
                //console.log("["+this.constructor.name+"] detached");
            },
            listensToChanged:function(){
                for(var key in this._eventsHandlers){
                    var e = this._eventsHandlers[key];
                    e.node.removeEventListener(e.type, e.handler);
                }
                this._eventsHandlers = {};
                for(var i = 0; i < this.listensTo.length; i++){
                    if(!this._handlerMap.hasOwnProperty(this.listensTo[i])) {
                        throw "unknown handler " + this.listensTo[i];
                    }
                    var handler = this[this._handlerMap[this.listensTo[i]]];
                    this._listensTo(this.listensTo[i], handler);
                }
            },
            _listensTo:function(event, callback, register){
                var handler = function(e){
                    console.log("["+this.constructor.name+"] receiving "+event+"[type:"+e.detail.type+"]");
                    callback.call(this, e.detail.type, e.detail, e);
                }.bind(this);
                document.addEventListener(event, handler);
                register !==false && (this._eventsHandlers[event] = {
                    handler:handler,
                    type:event,
                    node:document
                });
            },
            fireApplicationLink:function(type, params, source){
                this._fireApplication("cg-application-link", type, params, source);
            },
            fireApplicationError:function(type, params, source){
                this._fireApplication("cg-application-error", type, params, source);
            },
            fireApplicationEvent:function(type, params, source){
                this._fireApplication("cg-application-event", type, params, source);
            },
            _fireApplication:function(eventType, type, params, source){
                console.log("["+this.constructor.name+"] fireApplication(type:"+type+", params:"+CG.Utils.Json.stringify(params, true, 40)+")");
                this.asyncFire(eventType, {type:type, params:params, source:source || this}, {node:document});
            },
            fireDataRequest:function(options){
                options.type = (options.typePrefix !== false ? (this.cgName || this.constructor.name) + "/" : "") + options.type;
                options.el = this;
                options.source = options.source || this;
                options.params = options.params || {};
                options.params.context = this.dataContext || {};
                console.log("["+this.constructor.name+"] fireDataRequest(type:"+options.type+", params:"+CG.Utils.Json.stringify(options.params, true, 100)+")");
                this.asyncFire("cg-data-request", options, {node:document});
            },
            asyncFire:function(type, detail, options){
                this.async(function(){
                    this.fire(type, detail, options);
                });
            },
            isDataAware:function(){
                return this.globals.dataAware;
            },
            dataContextChanged:function(newValue, oldValue){
                if(!newValue || !newValue.value) return;
                this.reload();
            },
            reload:function(){},
            globalsContextChanged:function(newValue, oldValue){
                if(!newValue || !newValue.value) return;
                this.contextChanged(newValue, oldValue);
            },
            contextChanged:function(newValue, oldValue){ // TODO REFACTOR
            },
            globalsChanged:function(change){
//                console.log("["+this.constructor.name+"] ######################## " + CG.Utils.Json.stringify(change, true));
//                this.notifyPath(change.path, change.value);
            },
            setGlobal:function(path, value, notifySubProps){
                path = "globals." + path;
                this.set(path, value);
                this._fireApplication("cg-global", "changed", {
                    path:path,
                    value:value
                }, this);
//                if(notifySubProps) {
//                    notifySubProps.forEach(function(prop){
//                        this._fireApplication("cg-global", "changed", {
//                            path:path + "." + prop,
//                            value:value[prop]
//                        }, this);
//                    }.bind(this));
//                }
            },
            _onGlobalChangeEvent:function(type, event, e){
                //if(event.source == this) return;
                console.log("["+this.constructor.name+"] onGlobalChangeEvent " + event.params.path + "=" + CG.Utils.Json.stringify(event.params.value, true, 100));
                this.notifyPath(event.params.path, event.params.value);
                var path = event.params.path;
                path = path.substring("globals.".length);
                this.onGlobalChangeEvent(path, event.params.value);
            },
            onGlobalChangeEvent:function(path, value){},
            onApplicationLink:function(type, event, e){},
            onApplicationEvent:function(type, event, e){},
            onApplicationError:function(type, event, e){},

        };

        CG.BaseBehavior = [CGBaseBehaviorImpl, CG.UtilitiesBehavior];
    })();
</script>
